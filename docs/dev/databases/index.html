<!DOCTYPE html>
<html lang="en-gb">

<head>
  <meta name="generator" content="Hugo 0.80.0" />
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Databases | Escape Velocity</title>

  
  
  
  
  
  

  

  <meta name="author" content="Christina Unger">


  <meta property="og:title" content="Databases" />
<meta property="og:description" content="SQL. PostgreSQL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://cunger.github.io/docs/dev/databases/" />
<meta property="article:published_time" content="2020-01-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-10T00:00:00+00:00" />

  




  
  
  
  
  

  <link rel="canonical" href="http://cunger.github.io/docs/dev/databases/">  

  <link href="/css/font.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.css" rel="stylesheet" type="text/css">
  <link href="/css/highlight.css" rel="stylesheet" type="text/css">
  <link href="/css/master.css" rel="stylesheet" type="text/css">
  
 <link href="/css/custom.css" rel="stylesheet" type="text/css">
  
  <script src="/js/jquery-2.1.4.min.js" type="text/javascript">
  </script>

  <script type="text/javascript" src="/js/tocbot.min.js"></script>

  
  
</head>

<body class="page-kube">
  <header> <div class="show-sm">
    <div id="nav-toggle-box">
      <div id="nav-toggle-brand">
        <a href="/">Escape Velocity</a>
      </div><a data-component="toggleme" data-target="#top" href="#" id="nav-toggle"><i class="kube-menu"></i></a>
    </div>
  </div>
  <div class="hide-sm" id="top">
    <div id="top-brand">
      <a href="/" title="home">Escape Velocity</a>
    </div>
    <nav id="top-nav-main">
      <ul>
       
       <li><a href="/docs/maths">Mathematics</a></li>
       <li><a href="/docs/physics">Physics</a></li>
       <li><a href="/docs/nuctec">Nuclear Engineering</a></li>
       <li><a href="/docs/dev">Software Development</a></li>
       <li><a href="/about">About</a></li>
      </ul>
    </nav>
    <nav id="top-nav-extra">
      <ul>
        
      </ul>
    </nav>
  </div>
 </header>
  <main>
  <div id="main">
    <div id="hero">
      <h1> Databases </h1>
      <p class="hero-lead">
         SQL. PostgreSQL.
      </p>

    </div>
    <div id="kube-component" class="content">
    
<nav id="contents">
    <ol class="js-toc">
    </ol>
</nav>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded",
function(){
tocbot.init({

tocSelector: '.js-toc',

contentSelector: '.content',

headingSelector: 'h1'
})
}
);
</script>




    <h1 id="relational-model">Relational model</h1>
<p>The <em>relational model</em> specifies a mathematically grounded way to store, organize, and manipulate data in a set of tables (<em>relations</em>, which also comprise views and sequences). The schema specifies the names, data types and constraints of the columns (<em>fields</em>) that make up the table, and the actual data are the rows (<em>records</em>) filling it. This model is the foundation of how relational databases persist data.</p>
<p>A <em>conceptual schema</em> is a high-level design of entities (any recognizable objects in the real world) and their relationships, whereas a <em>physical schema</em> is a database-specific design focused on the implementation of the conceptual schema.</p>
<p>Usually, different kinds of entities are modeled through separate tables, and each row represents an entity instance. A <em>relationship</em> describes a connection between these entities (e.g. between customers and orders, and between orders and products), more physically by cross-referencing columns using primary- and foreign-key constraints. The cardinality of such a relationship specifies the number of objects on each side of the relationship, and modality indicates whether a relationship is optional or required.</p>
<ul>
<li>
<p><em>One-to-one relationships</em> are implemented by means of a unique foreign key.</p>
</li>
<li>
<p><em>One-to-many relationships</em> are implemented by a non-unique foreign key, where the <em>many</em>-side will have a foreign key identifying the <em>one</em>-side.</p>
</li>
<li>
<p><em>Many-to-many relationships</em> are implemented as a cross-reference table T3 that uses two foreign keys, to primary key of T1 and primary key of T2, together forming the primary key of T3.</p>
</li>
</ul>
<p><strong>Visualization:</strong> <a href="http://www.conceptdraw.com/How-To-Guide/picture/erd-diagrams-software-tools-for-design-element-crows-foot/Crows-Foot-notation-symbols.png">Crow&rsquo;s Foot Notation</a></p>
<p><img src="/images/docs/crows.png" alt="Crow&rsquo;s Foot Notation"></p>
<h1 id="keys">Keys</h1>
<p>Keys are specific kinds of constraints (i.e. rules on what kind of data is allowed in a column) and as such part of the schema definition. Their main purpose is to  ensure data integrity in the sense that data records can be uniquely identified and referenced.</p>
<h2 id="primary-keys">Primary keys</h2>
<p>A <em>primary key</em> is a collection of one or more columns that uniquely identifies each row in a table. In other words, the constraint <code>PRIMARY KEY</code> is the same as <code>NOT NULL UNIQUE</code>.</p>
<p>Each relational table can have only one primary key. When a primary key is created, also an index is created, that facilitates data selection and sorting based on the primary key column.</p>
<p>Keys can be <em>natural</em>, i.e. one or several columns that happen to be unique, or more likely <em>surrogate</em>, i.e. created for the specific purpose of being a unique identifier, such as auto-incrementing integers or UUIDs.</p>
<h2 id="foreign-keys">Foreign keys</h2>
<p>A <em>foreign key</em> is a column that refers to the primary key of another table, thereby acting as a cross-reference between tables.
Foreign key columns obviously need to have the same data type as the primary key column of the other table, and in most DBMS the foreign key constraint also prevents foreign key values that don&rsquo;t exist as primary key value (<em>referential integrity</em>).</p>
<p>As opposed to primary keys, foreign keys don&rsquo;t need to be unique, can be <code>NULL</code>, and there can be arbitrarily many of them in one table.</p>
<p>A column can be both a primary and a foreign key.</p>
<h1 id="normalization">Normalization</h1>
<p>The goal of <em>normalization</em> is to design the schema in a way that it avoids or at least minimizes anomalies, mainly by distributing information across separate tables.</p>
<ul>
<li><em>Update anomaly:</em> If data is duplicated, updating it in one place while not updating it in another leads to inconsistencies, e.g. leading to different answers to a query that should only have one.</li>
<li><em>Insertion and deletion anomaly:</em> When storing particular information only together with other information, e.g. contact details in an events table, then that information is not available independently, i.e. it can only be inserted when other information is inserted, and is lost when that other information is deleted.</li>
</ul>
<h1 id="postgresql">PostgreSQL</h1>
<h2 id="basic-commands">Basic commands</h2>
<p>Lists all databases and exit:</p>
<pre><code>$ psql -l
</code></pre><p>Connect to database:</p>
<pre><code>$ psql hero-database username
</code></pre><p>Or via postgres terminal:</p>
<pre><code>$ sudo -i -u postgres
$ psql
postgres=# \l
postgres=# \c hero-database
hero-database=#
</code></pre><h3 id="command-line">Command line</h3>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>createdb demo</code></td>
<td>creates a new database called <code>demo</code></td>
</tr>
<tr>
<td><code>dropdb demo</code></td>
<td>deletes the database called <code>demo</code></td>
</tr>
<tr>
<td><code>psql -d demo</code></td>
<td>start a <code>psql</code> session, connecting to the database <code>demo</code></td>
</tr>
</tbody>
</table>
<h2 id="postgresql-console">PostgreSQL console</h2>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\l</code>, <code>\list</code></td>
<td>display all databases</td>
</tr>
<tr>
<td><code>\c demo</code></td>
<td>connect to database <code>demo</code></td>
</tr>
<tr>
<td><code>\dt</code></td>
<td>display all tables of the current database</td>
</tr>
<tr>
<td><code>\d books</code></td>
<td>show the schema of the table <code>books</code></td>
</tr>
<tr>
<td><code>\?</code></td>
<td>list of console commands</td>
</tr>
<tr>
<td><code>\h</code></td>
<td>list of SQL help options</td>
</tr>
<tr>
<td><code>\q</code></td>
<td>quit</td>
</tr>
</tbody>
</table>
<h2 id="importing-and-exporting-data">Importing and exporting data</h2>
<p><em>Importing from SQL file:</em></p>
<p>Command line:</p>
<pre><code>$ psql -d demo &lt; dump.sql
</code></pre><p><code>psql</code> console:</p>
<pre><code># \i /path/to/dump.sql
</code></pre><p><em>Importing from CSV file:</em></p>
<p><code>psql</code> console:</p>
<pre><code># \copy table          from 'table.csv' with CSV HEADER DELIMITER ',';
# \copy table (c1, c2) from 'table.csv' with CSV HEADER DELIMITER ',';
</code></pre><p><code>\copy</code> invokes the corresponding SQL command <code>COPY</code>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">COPY</span> <span style="color:#00a8c8">table</span>               <span style="color:#00a8c8">FROM</span> <span style="color:#d88200">&#39;absolute/path/to/table.csv&#39;</span> <span style="color:#00a8c8">WITH</span> <span style="color:#111">CSV</span> <span style="color:#111">HEADER</span> <span style="color:#00a8c8">DELIMITER</span> <span style="color:#d88200">&#39;,&#39;</span><span style="color:#111">;</span>
<span style="color:#00a8c8">COPY</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">,</span> <span style="color:#111">color</span><span style="color:#111">)</span> <span style="color:#00a8c8">FROM</span> <span style="color:#d88200">&#39;absolute/path/to/table.csv&#39;</span> <span style="color:#00a8c8">WITH</span> <span style="color:#111">CSV</span> <span style="color:#111">HEADER</span> <span style="color:#00a8c8">DELIMITER</span> <span style="color:#d88200">&#39;,&#39;</span><span style="color:#111">;</span>
</code></pre></div><p>Note that <code>HEADER</code> just means the first line is going to be ignored;
the headers are not used for matching with the table columns.
So if the order of columns in the CSV differs from the order of columns
in the table schema, the columns have to be specified in the correct order
in the <code>COPY</code> statement.</p>
<p><em>Exporting a database or a specific table into an SQL file:</em></p>
<p>Command line:</p>
<pre><code>$ pg_dump -d demo [-t table] [--inserts] -f dump.sql
</code></pre><h2 id="data-types">Data types</h2>
<p>Data types are used by databases to decide how much memory to allocate to the values, how to perform operations and calculations on them, and how to sort them.</p>
<ul>
<li><a href="https://www.w3schools.com/sql/sql_datatypes.asp">SQL datatypes</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/datatype.html">PostgreSQL datatypes</a></li>
</ul>
<h3 id="serial">Serial</h3>
<p><code>serial</code> is a notational shortcut for creating a sequence:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">items</span> <span style="color:#111">(</span>
  <span style="color:#111">id</span> <span style="color:#111">serial</span>
<span style="color:#111">);</span>

<span style="color:#75715e">-- is interpreted as:
</span><span style="color:#75715e"></span><span style="color:#00a8c8">CREATE</span> <span style="color:#111">SEQUENCE</span> <span style="color:#111">items_id_seq</span><span style="color:#111">;</span>
<span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">items</span> <span style="color:#111">(</span>
  <span style="color:#111">id</span> <span style="color:#111">integer</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#111">nextval</span><span style="color:#111">(</span><span style="color:#d88200">&#39;items_id_seq&#39;</span><span style="color:#111">)</span>
<span style="color:#111">);</span>
</code></pre></div><p>Sequences are a special kind of database object designed for generating auto-incrementing unique numeric identifiers, usually used for artificial primary key columns. Sequences consist of a single-row table with a value of type <code>bigint</code> together with information on the sequence, as well as a generator for incrementing the numeric value. The value can be accessed using <code>nextval('sequence_name')</code> and <code>currval('sequence_name')</code>, and can be set using <code>setval('sequence_name', value)</code>.</p>
<pre><code># select * from items_id_seq;

 sequence_name | last_value | start_value | increment_by |      max_value      | min_value | cache_value | log_cnt | is_cycled | is_called
---------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+-----------
 items_id_seq  |          1 |           1 |            1 | 9223372036854775807 |         1 |           1 |       0 | f         | f

# select nextval('items_id_seq');

 nextval
---------
       1
(1 row)

# select nextval('items_id_seq');

 nextval
---------
       2
(1 row)
</code></pre><p>Start and incrementing value (default <code>1</code>) as well as other options (such as min and max values) can be specified explicitly, e.g.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#111">SEQUENCE</span> <span style="color:#111">id_seq</span>
<span style="color:#00a8c8">START</span> <span style="color:#00a8c8">WITH</span> <span style="color:#ae81ff">10</span>
<span style="color:#00a8c8">INCREMENT</span> <span style="color:#00a8c8">BY</span> <span style="color:#ae81ff">2</span><span style="color:#111">;</span>
</code></pre></div><p>Decrementing sequences can be created by specifying <code>INCREMENT BY -1</code>.</p>
<p>A sequence can also be dropped like any other table:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">DROP</span> <span style="color:#111">SEQUENCE</span> <span style="color:#111">id_seq</span><span style="color:#111">;</span>
</code></pre></div><p>An alternative for unique identifiers are UUIDs:</p>
<ul>
<li><code>uuid</code>, e.g. <code>a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11</code></li>
</ul>
<h3 id="numerical-values">Numerical values</h3>
<ul>
<li>
<p><code>integer</code> (alias: <code>int</code>)</p>
</li>
<li>
<p><code>real</code>, with variable precision and special values <code>Infinity</code>, <code>-Infinity</code>, <code>NaN</code></p>
<p>Beware that not all floating point numbers (like <code>pi()</code>) can be stored exactly, so the binary arithmetic performed on them can lead to errors.
For example, <code>1.0 - 0.2 - 1.0 + 0.2</code> with <code>real</code>s likely will not end up to be <code>0</code> but something like <code>5.551115123125783E-17</code>.
Therefore, floating point numbers should never be used to store information where exact values are needed (e.g. money).</p>
</li>
<li>
<p><code>numeric</code> (alias: <code>decimal</code>), <code>numeric(precision, scale)</code>, or <code>numeric(precision)</code> with <code>scale = 0</code></p>
<p><code>numeric(4, 2)</code> are precise values with (up to) 4 digits, 2 of which after the decimal point, e.g. <code>23.55</code> or <code>4.7</code> or <code>10</code>.
Values with more digits after the decimal point are rounded, e.g. <code>4.798</code> is stored as <code>4.80</code>.
With <code>numeric</code>s, <code>1.0 - 0.2 - 1.0 + 0.2</code> equals to <code>0</code>, as expected.</p>
</li>
</ul>
<h3 id="strings">Strings</h3>
<ul>
<li><code>char(fixed-length)</code></li>
<li><code>varchar(max-length)</code></li>
<li><code>text</code> (or <code>clob</code> for <em>character large object</em>) for textual information of any length</li>
</ul>
<p>Strings are always enclosed by single quotes.</p>
<pre><code>'some string'
'A long and winding road'
'That wasn''t a good idea'
'&quot;Indeed!&quot;'
</code></pre><p>Double quotes can be used to escape identifiers that are reserved keywords in SQL, e.g. <code>&quot;when&quot;</code>.</p>
<p>When filling an <code>char(n)</code> field with a string shorter than <code>n</code> characters, it will be filled up with spaces.
When trying to fill it with a string that is longer, an error is thrown (except when the excess characters are all spaces, in this case the string is truncated to the expected length).</p>
<p>If there is an explicit typecast to <code>char</code> or <code>varchar</code> and the string is longer than the provided length value, the string will be truncated to that length, e.g. <code>'too long'::varchar(5)</code> gets <code>'too l'</code>.</p>
<h3 id="date-and-time">Date and time</h3>
<ul>
<li><code>date</code> as <code>'yyyy-MM-dd'</code>, e.g. <code>'2017-08-20'</code></li>
<li><code>time</code> as <code>'hh:mm:ss'</code>, e.g. <code>'17:00:00'</code></li>
<li><code>timestamp</code> as <code>'yyyy-MM-dd hh:mm:ss'</code>, e.g. <code>'2017-08-20 17:00:00'</code></li>
</ul>
<p>Incomplete timestamps will be filled up automatically, e.g. <code>'2017-08-20'</code> becomes <code>'2017-08-20 00:00:00'</code>, and <code>'2017-08-20 17:00'</code> becomes <code>'2017-08-20 17:00:00'</code>. Thus, a condition to include all timestamps in 2017 would be: <code>t BETWEEN '2017-01-01' AND '2018-01-01'</code>.</p>
<p>Dates, times, and timestamps can be compared using the numerical comparison operators (<code>&lt;</code>, <code>=</code>, <code>BETWEEN</code>, etc.).</p>
<p><code>time</code> and <code>timestamp</code> have variants that include timezone information, e.g. <code>'2017-8-20 17:00:00+02'</code> with an 2-hour offset from UTC.</p>
<h3 id="boolean">Boolean</h3>
<ul>
<li><code>boolean</code></li>
</ul>
<p>Values can be <code>TRUE</code>, <code>FALSE</code>, or <code>NULL</code> (unknown).</p>
<h3 id="type-casts">Type casts</h3>
<pre><code>CAST (expression AS type)
expression::type
</code></pre><h1 id="sql">SQL</h1>
<p>SQL (<em>Structured Query Language</em>) is a special-purpose, declarative programming language to interact with relational databases.</p>
<p>The SQL vocabulary is categorized into three sub-vocabularies:</p>
<ul>
<li>
<p>The <em>Data Definition Language (DDL)</em> is a vocabulary for specifying the database <strong>schema</strong>, in articular for creating, modifying and deleting databases, tables, and constraints. This comprises all SQL commands that define the structure and properties of data but don&rsquo;t actually manipulate any data records, such as <code>CREATE</code>, <code>ALTER</code>, and <code>DROP</code>. (The latter is partly also DML, as dropping a database also deletes all data records in it.)</p>
</li>
<li>
<p>The <em>Data Manipulation Language (DML)</em> is a vocabulary for managing <strong>data</strong>, i.e. for retrieval of data records (querying) and manipulation of data records (inserting, modifying, deleting). Also known as CRUD, the four basic functions of persistent storage:
* Create data (<code>INSERT</code>)
* Read data (<code>SELECT</code>)
* Update data (<code>UPDATE</code>)
* Delete data (<code>DELETE</code>)</p>
</li>
<li>
<p>The <em>Data Control Language (DCL)</em> is a vocabulary for controlling rights and roles for accessing data. This comprises in particular <code>GRANT</code> and <code>REVOKE</code>.</p>
</li>
</ul>
<p>Adher to the <a href="http://www.sqlstyle.guide">SQL style guide</a>.</p>
<h1 id="sql-data-definition-language-ddl">SQL: Data Definition Language (DDL)</h1>
<h2 id="creating-and-dropping-tables">Creating and dropping tables</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table_name</span> <span style="color:#111">(</span>
    <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#111">column1</span><span style="color:#111">),</span>
    <span style="color:#111">column1</span> <span style="color:#f92672">&lt;</span><span style="color:#111">datatype</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span><span style="color:#111">column_constraints</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span>  
    <span style="color:#111">column2</span> <span style="color:#f92672">&lt;</span><span style="color:#111">datatype</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span><span style="color:#111">column_constraints</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span>
    <span style="color:#f92672">&lt;</span><span style="color:#111">table_constraints</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">);</span>
</code></pre></div><p><em>Addind and dropping a column:</em></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#00a8c8">ADD</span>  <span style="color:#00a8c8">COLUMN</span> <span style="color:#00a8c8">column</span> <span style="color:#f92672">&lt;</span><span style="color:#111">datatype</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span><span style="color:#00a8c8">constraints</span><span style="color:#f92672">&gt;</span><span style="color:#111">;</span>
<span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">COLUMN</span> <span style="color:#00a8c8">column</span><span style="color:#111">;</span>
</code></pre></div><p><em>Dropping tables and databases:</em></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table_name</span> <span style="color:#111">[</span> <span style="color:#111">,</span> <span style="color:#111">other_table_name</span> <span style="color:#111">];</span>

<span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">DATABASE</span> <span style="color:#111">database_name</span><span style="color:#111">;</span>
</code></pre></div><h2 id="constraints">Constraints</h2>
<p>The database schema can be used to restrict data injection in three ways:</p>
<ul>
<li>datatype</li>
<li>modifiers (column constraints)</li>
<li>table constraints</li>
</ul>
<table>
<thead>
<tr>
<th>Modifier</th>
<th>Constraint</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NOT NULL</code></td>
<td><code>CHECK (column IS NOT NULL)</code></td>
</tr>
<tr>
<td><code>UNIQUE</code></td>
<td><code>UNIQUE (column)</code></td>
</tr>
<tr>
<td></td>
<td><code>UNIQUE (column1, column2, ...)</code></td>
</tr>
<tr>
<td><code>DEFAULT value</code></td>
<td>-</td>
</tr>
<tr>
<td><code>PRIMARY KEY</code></td>
<td><code>PRIMARY KEY (column)</code></td>
</tr>
<tr>
<td></td>
<td><code>PRIMARY KEY (column1, column2, ...)</code></td>
</tr>
<tr>
<td><code>REFERENCES other_table (column)</code></td>
<td><code>FOREIGN KEY (column) REFERENCES other_table (column)</code></td>
</tr>
<tr>
<td><code>CHECK condition</code></td>
<td><code>CHECK condition</code></td>
</tr>
</tbody>
</table>
<p>Constraints can be explicitly named by prefixing <code>CONSTRAINT constraint_name ...</code>.</p>
<p>Options for foreign keys:</p>
<ul>
<li><code>ON UPDATE CASCADE</code></li>
<li><code>ON DELETE CASCADE</code></li>
<li><code>ON DELETE SET NULL</code></li>
<li><code>ON DELETE SET DEFAULT</code></li>
<li>and others</li>
</ul>
<p><code>FOREIGN KEY (c1) REFERENCES table (c2) ON DELETE CASCADE</code> means that if a value in the referenced column <code>c2</code> is deleted, all rows with that value in <code>c1</code> are deleted as well. Alternatively, the value in <code>c1</code> can be set to <code>NULL</code> or the column&rsquo;s default value.</p>
<p><code>FOREIGN KEY (c1) REFERENCES table (c2) ON UPDATE CASCADE</code> means that updates of values in <code>c2</code> are copied to the respective occurrences in <code>c1</code>.</p>
<p>If no options are specified, the default is <code>ON UPDATE RESTRICT</code> and <code>ON DELETE RESTRICT</code>, i.e. updating and deleting values in <code>c2</code> is not allowed if they are referenced in <code>c1</code>.</p>
<p>If a table has a multi-column primary key, the foreign key would be accordingly multi-column, e.g. <code>FOREIGN KEY (person_first_name, person_last_name) REFERENCES person (first_name, last_name)</code></p>
<h3 id="adding-a-constraint">Adding a constraint</h3>
<p>During table creation:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- Column constraint as modifier
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span>
  <span style="color:#111">id</span>    <span style="color:#111">serial</span>       <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
  <span style="color:#111">other</span> <span style="color:#111">integer</span>      <span style="color:#00a8c8">REFERENCES</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span><span style="color:#111">),</span>
  <span style="color:#111">age</span>   <span style="color:#111">integer</span>      <span style="color:#00a8c8">CHECK</span> <span style="color:#111">(</span><span style="color:#111">age</span> <span style="color:#00a8c8">BETWEEN</span> <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">AND</span> <span style="color:#ae81ff">100</span><span style="color:#111">),</span>
  <span style="color:#111">email</span> <span style="color:#111">varchar</span><span style="color:#111">(</span><span style="color:#ae81ff">100</span><span style="color:#111">)</span> <span style="color:#00a8c8">CHECK</span> <span style="color:#111">(</span><span style="color:#111">email</span> <span style="color:#00a8c8">LIKE</span> <span style="color:#d88200">&#39;%@%&#39;</span><span style="color:#111">)</span>
<span style="color:#111">);</span>

<span style="color:#75715e">-- Table constraint
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span>
  <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">),</span>
  <span style="color:#111">id</span>    <span style="color:#111">serial</span><span style="color:#111">,</span>
  <span style="color:#111">other</span> <span style="color:#111">integer</span><span style="color:#111">,</span>
  <span style="color:#111">age</span>   <span style="color:#111">integer</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">year</span>  <span style="color:#111">integer</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">CHECK</span> <span style="color:#111">(</span><span style="color:#111">age</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">AND</span> <span style="color:#ae81ff">2017</span> <span style="color:#f92672">-</span> <span style="color:#111">age</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">year</span><span style="color:#111">),</span>
  <span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#111">other</span><span style="color:#111">)</span> <span style="color:#00a8c8">REFERENCES</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span><span style="color:#111">)</span>
<span style="color:#111">);</span>
</code></pre></div><p>To an existing table:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">name</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span><span style="color:#111">);</span>
<span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">name</span> <span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span><span style="color:#111">)</span> <span style="color:#00a8c8">REFERENCES</span> <span style="color:#00a8c8">table</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span><span style="color:#111">);</span>
</code></pre></div><div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table_name</span> <span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">COLUMN</span> <span style="color:#00a8c8">column</span> <span style="color:#111">[</span><span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">name</span><span style="color:#111">]</span> <span style="color:#00a8c8">SET</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
<span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table_name</span> <span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">COLUMN</span> <span style="color:#00a8c8">column</span> <span style="color:#111">[</span><span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">name</span><span style="color:#111">]</span> <span style="color:#00a8c8">SET</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">;</span>
</code></pre></div><h3 id="deleting-constraints">Deleting constraints</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#00a8c8">constraint_name</span><span style="color:#111">;</span>

<span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#00a8c8">table</span> <span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">COLUMN</span> <span style="color:#00a8c8">column</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">;</span>
</code></pre></div><h3 id="enums">Enums</h3>
<p>Either as constraint:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CHECK</span> <span style="color:#111">(</span><span style="color:#00a8c8">column</span> <span style="color:#00a8c8">IN</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;value1&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;value2&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;value3&#39;</span><span style="color:#111">))</span>
</code></pre></div><p>Or by creating an own data type:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TYPE</span> <span style="color:#111">weekday</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">ENUM</span><span style="color:#111">(</span><span style="color:#d88200">&#39;monday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;tuesday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;wednesday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;thursday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;friday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;saturday&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;sunday&#39;</span><span style="color:#111">);</span>
</code></pre></div><h1 id="dql-data-manipulation-language-dml">DQL: Data Manipulation Language (DML)</h1>
<h2 id="inserting-records">Inserting records</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">INSERT</span> <span style="color:#00a8c8">INTO</span> <span style="color:#00a8c8">table_name</span> <span style="color:#111">(</span><span style="color:#111">column1</span><span style="color:#111">,</span> <span style="color:#111">column2</span><span style="color:#111">,</span> <span style="color:#111">column3</span><span style="color:#111">,</span> <span style="color:#111">...)</span>
<span style="color:#00a8c8">VALUES</span> <span style="color:#111">(</span><span style="color:#111">value1</span><span style="color:#111">,</span> <span style="color:#111">value2</span><span style="color:#111">,</span> <span style="color:#111">value3</span><span style="color:#111">,</span> <span style="color:#111">...),</span>
       <span style="color:#111">(</span><span style="color:#111">value1</span><span style="color:#111">,</span> <span style="color:#111">value2</span><span style="color:#111">,</span> <span style="color:#111">value3</span><span style="color:#111">,</span> <span style="color:#111">...);</span>
</code></pre></div><p><code>NULL</code> is inserted for all columns that are omitted in the <code>INSERT</code> statement.</p>
<p>If all columns are included in their expected order, the column names can be omitted:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">INSERT</span> <span style="color:#00a8c8">INTO</span> <span style="color:#00a8c8">table_name</span>
<span style="color:#00a8c8">VALUES</span> <span style="color:#111">(</span><span style="color:#111">value1</span><span style="color:#111">,</span> <span style="color:#111">value2</span><span style="color:#111">,</span> <span style="color:#111">value3</span><span style="color:#111">,</span> <span style="color:#111">...);</span>
</code></pre></div><h2 id="updating-records">Updating records</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">UPDATE</span> <span style="color:#00a8c8">table_name</span>
   <span style="color:#00a8c8">SET</span> <span style="color:#111">column1</span> <span style="color:#f92672">=</span> <span style="color:#111">value1</span><span style="color:#111">,</span>
       <span style="color:#111">column2</span> <span style="color:#f92672">=</span> <span style="color:#111">value2</span><span style="color:#111">,</span> <span style="color:#111">...</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">condition</span><span style="color:#111">;</span>
</code></pre></div><p>It is also possible to use arithmetic expressions, e.g. <code>SET price = 2 * price</code> or <code>SET years = years + 1</code>.</p>
<h2 id="deleting-records">Deleting records</h2>
<p>Deleting specific records:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">DELETE</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">table_name</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">condition</span><span style="color:#111">;</span>
</code></pre></div><p>Deleting all records:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">DELETE</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">table_name</span><span style="color:#111">;</span>
</code></pre></div><h1 id="sql-querying">SQL: Querying</h1>
<h2 id="operators">Operators</h2>
<p><em>String matching:</em></p>
<p><code>LIKE</code>, <code>NOT LIKE</code></p>
<p>Wildcards:</p>
<ul>
<li><code>_</code> matches exactly one character</li>
<li><code>%</code> matches zero or more characters</li>
</ul>
<p><em>Boolean:</em></p>
<p><code>AND</code>, <code>OR</code></p>
<p><em>Set inclusion:</em></p>
<p><code>IN</code>, <code>NOT IN</code>
e.g.</p>
<ul>
<li><code>WHERE id IN (1, 2)</code></li>
<li><code>WHERE id IN (SELECT ...)</code></li>
</ul>
<p><em>Comparison:</em></p>
<p><code>=</code>, <code>&lt;&gt;</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>BETWEEN ... AND ...</code></p>
<p>In PostgreSQL, <code>a BETWEEN x AND y</code> is equivalent to <code>a &gt;= x AND a &lt;= y</code>, i.e. works for numbers and date times and is inclusive.</p>
<p>If either side of an operator equals <code>NULL</code>, the result will be <code>NULL</code>. This is because <code>NULL</code> refers to a missing or unknown value, so the result of the comparison is also unknown. The same holds for most <a href="sql_functions.md">functions</a>.</p>
<p>Return values that are <code>NULL</code> are not be included in the result set.
Also, <code>NULL</code> values cannot be compared, so in results of statements with <code>ORDER BY</code> clauses rows with <code>NULL</code> values will appear either first or last.</p>
<p><em>Equality with <code>NULL</code></em>:</p>
<ul>
<li>A condition <code>column = NULL</code> will never be true, i.e. the result will always be empty.</li>
<li>A condition <code>column &lt;&gt; 'some value'</code> will not return rows where <code>column</code> is <code>NULL</code>.
Therefore, in conditions checking for <code>NULL</code>, always use <code>IS NULL</code> or <code>IS NOT NULL</code>.
This includes arrays like <code>('value1', 'value2', ...)</code>: they cannot contain <code>NULL</code>.</li>
</ul>
<h2 id="grouping">Grouping</h2>
<p><code>GROUP BY c</code> groups together all rows that have the same value in column <code>c</code>.</p>
<p><em>Example:</em></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- select the number of employees in each department in the year 2013
</span><span style="color:#75715e"></span><span style="color:#00a8c8">SELECT</span> <span style="color:#111">department</span><span style="color:#111">,</span> <span style="color:#00a8c8">COUNT</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">)</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">employees</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#00a8c8">year</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2013</span>
 <span style="color:#00a8c8">GROUP</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">department</span><span style="color:#111">;</span>
</code></pre></div><p>Columns other than <code>c</code> can have different values within one group, so it makes sense to aggregate on them, but it doesn&rsquo;t make sense to put them in a <code>SELECT</code> clause without aggregation (which of the values to return?).</p>
<p><code>GROUP BY column1, column2</code> groups by <code>(column1, column2)</code>, e.g. <code>GROUP BY last_name, first_name</code>.</p>
<p>In addition, groups can be filtered by means of <code>HAVING</code>.</p>
<p><em>Example:</em></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> <span style="color:#111">last_name</span><span style="color:#111">,</span> <span style="color:#111">first_name</span><span style="color:#111">,</span>
       <span style="color:#00a8c8">AVG</span><span style="color:#111">(</span><span style="color:#111">salary</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">average_salary</span><span style="color:#111">,</span>
       <span style="color:#00a8c8">COUNT</span><span style="color:#111">(</span><span style="color:#00a8c8">year</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">years_worked</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">employees</span>
 <span style="color:#00a8c8">GROUP</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">last_name</span><span style="color:#111">,</span> <span style="color:#111">first_name</span>
<span style="color:#00a8c8">HAVING</span> <span style="color:#111">years_worked</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>
 <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">average_salary</span> <span style="color:#00a8c8">DESC</span><span style="color:#111">;</span>
</code></pre></div><h2 id="joins">Joins</h2>
<p>Joins are clause in SQL statements that combine rows from two or more tables, based on a related column between them.</p>
<p><em>Inner join:</em></p>
<ul>
<li><strong>(INNER) JOIN</strong> contains all records in the intersection of both tables.</li>
</ul>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">table1</span>
       <span style="color:#00a8c8">JOIN</span> <span style="color:#111">table2</span>
         <span style="color:#00a8c8">ON</span> <span style="color:#111">table2</span><span style="color:#111">.</span><span style="color:#111">table1_column</span> <span style="color:#f92672">=</span> <span style="color:#111">table1</span><span style="color:#111">.</span><span style="color:#00a8c8">column</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">...;</span>
</code></pre></div><p>This can get as complex as necessary:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">table1</span>
       <span style="color:#00a8c8">JOIN</span> <span style="color:#111">table2</span>
         <span style="color:#00a8c8">ON</span> <span style="color:#111">table2</span><span style="color:#111">.</span><span style="color:#111">table1_column</span> <span style="color:#f92672">=</span> <span style="color:#111">table1</span><span style="color:#111">.</span><span style="color:#00a8c8">column</span>
       <span style="color:#00a8c8">JOIN</span> <span style="color:#111">table3</span>
         <span style="color:#00a8c8">ON</span> <span style="color:#111">(</span><span style="color:#111">table3</span><span style="color:#111">.</span><span style="color:#111">column1</span><span style="color:#111">,</span> <span style="color:#111">table3</span><span style="color:#111">.</span><span style="color:#111">column2</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">table1</span><span style="color:#111">.</span><span style="color:#111">column1</span><span style="color:#111">,</span> <span style="color:#111">table1</span><span style="color:#111">.</span><span style="color:#111">column2</span><span style="color:#111">)</span>
       <span style="color:#111">...</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">...;</span>
</code></pre></div><p><em>Outer joins:</em></p>
<ul>
<li><strong>LEFT (OUTER) JOIN</strong> contains all records in the left table, with matching records from the right table if present (otherwise <code>NULL</code>).</li>
<li><strong>RIGHT (OUTER) JOIN</strong> contains all records in the right table, with matching records from the left table if present (otherwise <code>NULL</code>).</li>
<li><strong>FULL (OUTER) JOIN</strong> combines the results of left and right join. This is particularly useful for including rows from T1 that don&rsquo;t have a match in T2 as well as rows in T2 that don&rsquo;t have a match in T1 without needing a full-blown cross join.</li>
</ul>
<p><em>Cross join:</em></p>
<ul>
<li><strong>CROSS JOIN</strong> corresponds to the Cartesian product and contains all records of the left table matched with each record in the right table.</li>
</ul>
<p>The cross join is what you get when you <code>SELECT * FROM table1, table2</code>.
An inner join then is like <code>SELECT * FROM table1, table2 WHERE table1.table2_id = table2.id</code>.</p>
<blockquote>
<p>CROSS JOIN is generally best suited to generating test data rather than production queries.</p>
</blockquote>
<p><em>Self joins:</em></p>
<p>A table can also be joined with itself.</p>
<p><em>Example:</em></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- all pairs of students that share the same room
</span><span style="color:#75715e"></span><span style="color:#00a8c8">SELECT</span> <span style="color:#111">s1</span><span style="color:#111">.</span><span style="color:#111">name</span><span style="color:#111">,</span> <span style="color:#111">s2</span><span style="color:#111">.</span><span style="color:#111">name</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">student</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">s1</span>
  <span style="color:#00a8c8">JOIN</span> <span style="color:#111">student</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">s2</span>
    <span style="color:#00a8c8">ON</span> <span style="color:#111">s1</span><span style="color:#111">.</span><span style="color:#111">room_number</span> <span style="color:#f92672">=</span> <span style="color:#111">s2</span><span style="color:#111">.</span><span style="color:#111">room_number</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">s1</span><span style="color:#111">.</span><span style="color:#111">id</span> <span style="color:#f92672">&lt;&gt;</span> <span style="color:#111">s2</span><span style="color:#111">.</span><span style="color:#111">id</span> <span style="color:#111">;</span>
</code></pre></div><h2 id="subqueries">Subqueries</h2>
<h2 id="performance">Performance</h2>
<p><code>EXPLAIN sql-statement</code> constructs a query plan and estimates the costs (in terms of system resources) for executing it.</p>
<p><code>EXPLAIN ANAYLYZE sql-statement</code> in addition executes the query and displays the time needed for planning and execution.</p>
<p>Useful to compare the efficiency of different queries, e.g. usually using sub-queries is much faster than using <code>JOIN</code>s.</p>
<p>When it comes to <code>ORDER BY</code>, it makes a big difference whether you look at an <strong>unindexed</strong> column, on which sorting is pretty costly (as it needs several passes on the table), or an <strong>indexed</strong> column, for which sorting comes for free because the index already gives you an order (so retrieval actually doesn&rsquo;t need any additional sorting). For example:</p>
<pre><code>auction=# EXPLAIN ANALYZE SELECT * FROM bids ORDER BY amount;

                                                QUERY PLAN                                                
----------------------------------------------------------------------------------------------------------
 Sort  (cost=104.83..108.61 rows=1510 width=26) (actual time=0.024..0.025 rows=26 loops=1)
   Sort Key: amount
   Sort Method: quicksort  Memory: 27kB
   -&gt;  Seq Scan on bids  (cost=0.00..25.10 rows=1510 width=26) (actual time=0.004..0.005 rows=26 loops=1)
 Planning time: 0.059 ms
 Execution time: 0.037 ms

auction=# EXPLAIN ANALYZE SELECT * FROM bids ORDER BY item_id;

                                                              QUERY PLAN                                                               
---------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using bids_item_id_bidder_id_idx on bids  (cost=0.15..70.80 rows=1510 width=26) (actual time=0.006..0.012 rows=26 loops=1)
 Planning time: 0.058 ms
 Execution time: 0.034 ms
</code></pre><p>Also, counting is more efficient when done in the database than in the application, because for the latter case, all data to be counted needs to be transfered.</p>
<p>Also, avoid N+1 queries i the application, i.e. queries that are the result of performing an additional query for each element in a collection.</p>
<h2 id="comments">Comments</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#75715e">/* query to retrieve the radius or a circle */</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#111">radius</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#111">circles</span>
 <span style="color:#00a8c8">WHERE</span> <span style="color:#111">something</span>      <span style="color:#75715e">-- fill in condition
</span><span style="color:#75715e"></span>   <span style="color:#00a8c8">AND</span> <span style="color:#111">something_else</span> <span style="color:#75715e">-- here as well
</span></code></pre></div><h2 id="views">Views</h2>
<p>A view is a virtual table, created by specifying the query from which is results and a name:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">VIEW</span> <span style="color:#111">view_name</span>
<span style="color:#00a8c8">AS</span> <span style="color:#f92672">&lt;</span><span style="color:#111">query</span><span style="color:#f92672">&gt;</span>
</code></pre></div><p>It can then be queried like any other table (<code>SELECT * FROM view_name;</code>), with the only difference that virtual tables are not stored physically: every time data is retrieved from a view, the database re-runs the underlying query.</p>
<p>Views can be deleted as expected:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">VIEW</span> <span style="color:#111">view_name</span><span style="color:#111">;</span>
</code></pre></div><h1 id="sql-function">SQL: Function</h1>
<h2 id="aggregate-functions">Aggregate functions</h2>
<ul>
<li>
<p><code>COUNT(*)</code> counts all rows (therefore avoid in <code>LEFT JOIN</code>s if you want to only count rows that have values in both tables)</p>
</li>
<li>
<p><code>COUNT(x)</code> counts all rows in which <code>x</code> is a non-<code>NULL</code> value</p>
</li>
<li>
<p><code>SUM(x)</code></p>
</li>
<li>
<p><code>AVG(x)</code></p>
</li>
<li>
<p><code>MIN(x)</code></p>
</li>
<li>
<p><code>MAX(x)</code></p>
</li>
</ul>
<p>Where <code>x</code> can be any value: <code>column</code>, <code>DISTINCT column</code>, <code>ROUND(column1 / COALESCE(column2, 0))</code>, etc.
Note that <code>NULL</code> as value is ignored.</p>
<h2 id="string-functions">String functions</h2>
<ul>
<li>
<p>Concatenation <code>||</code>, e.g.</p>
<ul>
<li><code>SELECT 'pi is ' || pi() ;</code></li>
<li><code>SELECT first_name || ' ' || last_name FROM persons;</code></li>
<li><code>SELECT id FROM item WHERE lower(name) = 'whatever letters were capitalized';</code></li>
</ul>
</li>
<li>
<p><code>length(column)</code></p>
</li>
<li>
<p><code>lower(column)</code>, <code>upper(column)</code>, <code>initcap(column)</code> (first letter uppercase, all other letters lower case)</p>
</li>
<li>
<p><code>substring(column, start_char, number_of_chars)</code></p>
</li>
</ul>
<h2 id="numeric-functions">Numeric functions</h2>
<ul>
<li><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code></li>
<li><code>mod(x, y)</code> calculating the remainder of <code>x/y</code></li>
</ul>
<p>Note that <code>/</code> in PostgreSQL is integer division, i.e. <code>1/4</code> yields <code>0</code> and in order to get <code>0.25</code> you have to use decimals (e.g. <code>1.0/4.0</code>), e.g. by means of casting <code>CAST(column AS decimal)</code>.</p>
<ul>
<li>
<p><code>abs(x)</code> for the absolute value of <code>x</code></p>
</li>
<li>
<p><code>round(x)</code> for rounding to the nearest integer</p>
</li>
<li>
<p><code>round(x, i)</code> for rounding to a decimal with <code>i</code> decimals (in PostgreSQL this only works when <code>x</code> is of type <code>decimal</code>)</p>
</li>
<li>
<p><code>ceil(x)</code> for rounding up, <code>floor(x)</code> for rounding down, and <code>trunc(x)</code> for rounding towards 0 (i.e. rounding up for negative numbers and rounding down for positive ones)</p>
</li>
</ul>
<h2 id="date-and-time-functions">Date and time functions</h2>
<ul>
<li><code>current_date</code>, <code>current_time</code>, <code>current_timestamp</code></li>
<li><code>EXTRACT(field FROM column)</code>, where <code>field</code> can be <code>YEAR</code>, <code>MONTH</code>, <code>DAY</code>, <code>HOUR</code>, <code>MINUTE</code>, <code>SECOND</code>, e.g.</li>
<li><code>AT TIME ZONE '...'</code> for conversion to local time, e.g. <code>time AT TIME ZONE 'Europe/Warsaw'</code></li>
<li><code>-</code> for difference between two timestamps</li>
<li><code>+</code> for moving a date time by an interval (such as <code>INTERVAL '4' HOUR</code> or <code>INTERVAL '1' DAY</code>)</li>
</ul>
<p>The operation <code>-</code> and <code>+</code> are, for example, useful for</p>
<ul>
<li>not caring about the specific end date of a month: <code>date BETWEEN '2010-01-01' AND CAST('2010-02-01' AS date) + INTERVAL '1' MONTH</code></li>
<li>checking for something within the past <code>x</code> days (or hours, or the like): <code>date &gt; CURRENT_DATE - INTERVAL 'x' DAY</code></li>
<li>checking for something older than 10 years: <code>birth_date &lt; CURRENT_DATE - INTERVAL '10' YEAR</code></li>
<li>something around the current time: <code>time BETWEEN (CURRENT_TIME - INTERVAL '1' HOUR) AND (CURRENT_TIME + INTERVAL '1' HOUR)</code></li>
</ul>
<h2 id="working-with-nulls">Working with <code>NULL</code>s</h2>
<ul>
<li>
<p><code>COALESCE(value1, value2, ...)</code> returns the first of the values that is not <code>NULL</code>. This is useful, e.g., for default values during query time, e.g.:</p>
<ul>
<li><code>SELECT COALESCE(name, 'product ' || id, 'n/a') FROM item;</code></li>
<li><code>COALESCE(number * 2, 0)</code>
Note that both values need to have the same data type, i.e. <code>COALESCE(date, 'no date')</code> will not work and needs to be <code>COALESCE(CAST(date AS varchar), 'no date')</code>.</li>
</ul>
</li>
<li>
<p><code>NULLIF(x, y)</code> returns <code>NULL</code> if <code>x</code> and <code>y</code> are equal, else <code>x</code>. This is useful, e.g., for</p>
<ul>
<li>avoiding division by 0: <code>1 / NULLIF(all - some, 0)</code></li>
<li>counting only non-0 values: <code>COUNT(NULLIF(column, 0))</code></li>
</ul>
</li>
</ul>


    
    </div>
  </div>
</main>
  <footer> <footer id="footer">
  <nav>
    <ul>
      <li><span>2020 &middot; Christina Unger</span></li>
      <li>
        Made with <a href="https://gohugo.io/">Hugo</a> ♥ Theme based on <a href="https://kube.elemnts.net/">Kube</a>.
      </li>
    </ul>
  </nav>
</footer>
 </footer>

  <script src="/js/kube.js" type="text/javascript">
  </script>
  <script src="/js/kube.legenda.js" type="text/javascript">
  </script>
  <script src="/js/master.js" type="text/javascript">
  </script>
</body>

</html>
